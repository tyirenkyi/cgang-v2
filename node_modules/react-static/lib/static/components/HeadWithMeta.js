"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = makeHeadWithMeta;
exports.InlineStyle = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _react = _interopRequireDefault(require("react"));

var _utils = require("../../utils");

var _plugins = _interopRequireDefault(require("../plugins"));

//
// import packagejson from '../../../package.json'
// const { version } = packagejson
var REGEX_FOR_STYLE_TAG = /<style>|<\/style>/gi;

var InlineStyle = function InlineStyle(_ref) {
  var clientCss = _ref.clientCss;
  return _react["default"].createElement("style", {
    key: "clientCss",
    type: "text/css",
    dangerouslySetInnerHTML: {
      __html: clientCss.toString().replace(REGEX_FOR_STYLE_TAG, '')
    }
  });
};

exports.InlineStyle = InlineStyle;

function makeHeadWithMeta(_x) {
  return _makeHeadWithMeta.apply(this, arguments);
}

function _makeHeadWithMeta() {
  _makeHeadWithMeta = (0, _asyncToGenerator2["default"])(
  /*#__PURE__*/
  _regenerator["default"].mark(function _callee(state) {
    var head, route, clientScripts, config, clientStyleSheets, clientCss, pluginHeads;
    return _regenerator["default"].wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            head = state.head, route = state.route, clientScripts = state.clientScripts, config = state.config, clientStyleSheets = state.clientStyleSheets, clientCss = state.clientCss;
            _context.next = 3;
            return _plugins["default"].headElements([], state);

          case 3:
            pluginHeads = _context.sent;
            return _context.abrupt("return", function (_ref2) {
              var children = _ref2.children,
                  rest = (0, _objectWithoutProperties2["default"])(_ref2, ["children"]);
              var renderLinkCSS = !route.redirect && !config.inlineCss;
              var useHelmetTitle = head.title && head.title[0] && head.title[0].props.children !== '';

              var childrenArray = _react["default"].Children.toArray(children);

              if (useHelmetTitle) {
                head.title[0] = _react["default"].cloneElement(head.title[0], {
                  key: 'title'
                });
                childrenArray = childrenArray.filter(function (child) {
                  if (child.type === 'title') {
                    // Filter out the title of the Document in static.config.js
                    // if there is a helmet title on this route
                    return false;
                  }

                  return true;
                });
              }

              var childrenCSS = childrenArray.filter(function (child) {
                if (child.type === 'link' && child.props && child.props.rel === 'stylesheet') {
                  return true;
                }

                if (child.type === 'style') {
                  return true;
                }

                return false;
              });
              var childrenJS = childrenArray.filter(function (child) {
                return child.type === 'script';
              });
              childrenArray = childrenArray.filter(function (child) {
                if (child.type === 'link' && child.props && child.props.rel === 'stylesheet') {
                  return false;
                }

                if (child.type === 'style') {
                  return false;
                }

                if (child.type === 'script') {
                  return false;
                }

                return true;
              });
              return _react["default"].createElement("head", rest, _react["default"].createElement("meta", {
                name: "generator",
                content: "React Static"
              }), head.base, useHelmetTitle && head.title, head.meta, childrenJS, !route.redirect && clientScripts.map(function (script) {
                return _react["default"].createElement("link", {
                  key: "clientScript_".concat(script),
                  rel: "preload",
                  as: "script",
                  href: (0, _utils.makePathAbsolute)((0, _utils.pathJoin)(process.env.REACT_STATIC_ASSETS_PATH, script))
                });
              }), childrenCSS, renderLinkCSS && clientStyleSheets.reduce(function (memo, styleSheet) {
                var href = (0, _utils.makePathAbsolute)((0, _utils.pathJoin)(process.env.REACT_STATIC_ASSETS_PATH, styleSheet));
                return [].concat((0, _toConsumableArray2["default"])(memo), [_react["default"].createElement("link", {
                  key: "clientStyleSheetPreload_".concat(styleSheet),
                  rel: "preload",
                  as: "style",
                  href: href
                }), _react["default"].createElement("link", {
                  key: "clientStyleSheet_".concat(styleSheet),
                  rel: "stylesheet",
                  href: href
                })]);
              }, []), head.link, head.noscript, head.script, config.inlineCss && _react["default"].createElement(InlineStyle, {
                clientCss: clientCss
              }), head.style, pluginHeads, childrenArray);
            });

          case 5:
          case "end":
            return _context.stop();
        }
      }
    }, _callee);
  }));
  return _makeHeadWithMeta.apply(this, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdGF0aWMvY29tcG9uZW50cy9IZWFkV2l0aE1ldGEuanMiXSwibmFtZXMiOlsiUkVHRVhfRk9SX1NUWUxFX1RBRyIsIklubGluZVN0eWxlIiwiY2xpZW50Q3NzIiwiX19odG1sIiwidG9TdHJpbmciLCJyZXBsYWNlIiwibWFrZUhlYWRXaXRoTWV0YSIsInN0YXRlIiwiaGVhZCIsInJvdXRlIiwiY2xpZW50U2NyaXB0cyIsImNvbmZpZyIsImNsaWVudFN0eWxlU2hlZXRzIiwicGx1Z2lucyIsImhlYWRFbGVtZW50cyIsInBsdWdpbkhlYWRzIiwiY2hpbGRyZW4iLCJyZXN0IiwicmVuZGVyTGlua0NTUyIsInJlZGlyZWN0IiwiaW5saW5lQ3NzIiwidXNlSGVsbWV0VGl0bGUiLCJ0aXRsZSIsInByb3BzIiwiY2hpbGRyZW5BcnJheSIsIlJlYWN0IiwiQ2hpbGRyZW4iLCJ0b0FycmF5IiwiY2xvbmVFbGVtZW50Iiwia2V5IiwiZmlsdGVyIiwiY2hpbGQiLCJ0eXBlIiwiY2hpbGRyZW5DU1MiLCJyZWwiLCJjaGlsZHJlbkpTIiwiYmFzZSIsIm1ldGEiLCJtYXAiLCJzY3JpcHQiLCJwcm9jZXNzIiwiZW52IiwiUkVBQ1RfU1RBVElDX0FTU0VUU19QQVRIIiwicmVkdWNlIiwibWVtbyIsInN0eWxlU2hlZXQiLCJocmVmIiwibGluayIsIm5vc2NyaXB0Iiwic3R5bGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUNBOztBQUZBO0FBR0E7QUFFQTtBQUVBLElBQU1BLG1CQUFtQixHQUFHLHFCQUE1Qjs7QUFFTyxJQUFNQyxXQUFXLEdBQUcsU0FBZEEsV0FBYztBQUFBLE1BQUdDLFNBQUgsUUFBR0EsU0FBSDtBQUFBLFNBQ3pCO0FBQ0UsSUFBQSxHQUFHLEVBQUMsV0FETjtBQUVFLElBQUEsSUFBSSxFQUFDLFVBRlA7QUFHRSxJQUFBLHVCQUF1QixFQUFFO0FBQ3ZCQyxNQUFBQSxNQUFNLEVBQUVELFNBQVMs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RCxVQUF0QixDQURMO0FBRUUsa0JBQUEsR0FBRyxFQUFDLFlBRk47QUFHRSxrQkFBQSxJQUFJLEVBQUVDO0FBSFIsa0JBUkY7QUFjRCxlQW5CRCxFQW1CRyxFQW5CSCxDQW5CSixFQXVDR3RDLElBQUksQ0FBQ3VDLElBdkNSLEVBd0NHdkMsSUFBSSxDQUFDd0MsUUF4Q1IsRUF5Q0d4QyxJQUFJLENBQUMrQixNQXpDUixFQTBDRzVCLE1BQU0sQ0FBQ1MsU0FBUCxJQUFvQixnQ0FBQyxXQUFEO0FBQWEsZ0JBQUEsU0FBUyxFQUFFbEI7QUFBeEIsZ0JBMUN2QixFQTJDR00sSUFBSSxDQUFDeUMsS0EzQ1IsRUE0Q0dsQyxXQTVDSCxFQTZDR1MsYUE3Q0gsQ0FERjtBQWlERCxhQWpIWTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0J1xuLy9cbmltcG9ydCB7IHBhdGhKb2luLCBtYWtlUGF0aEFic29sdXRlIH0gZnJvbSAnLi4vLi4vdXRpbHMnXG5pbXBvcnQgcGx1Z2lucyBmcm9tICcuLi9wbHVnaW5zJ1xuLy8gaW1wb3J0IHBhY2thZ2Vqc29uIGZyb20gJy4uLy4uLy4uL3BhY2thZ2UuanNvbidcblxuLy8gY29uc3QgeyB2ZXJzaW9uIH0gPSBwYWNrYWdlanNvblxuXG5jb25zdCBSRUdFWF9GT1JfU1RZTEVfVEFHID0gLzxzdHlsZT58PFxcL3N0eWxlPi9naVxuXG5leHBvcnQgY29uc3QgSW5saW5lU3R5bGUgPSAoeyBjbGllbnRDc3MgfSkgPT4gKFxuICA8c3R5bGVcbiAgICBrZXk9XCJjbGllbnRDc3NcIlxuICAgIHR5cGU9XCJ0ZXh0L2Nzc1wiXG4gICAgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUw9e3tcbiAgICAgIF9faHRtbDogY2xpZW50Q3NzLnRvU3RyaW5nKCkucmVwbGFjZShSRUdFWF9GT1JfU1RZTEVfVEFHLCAnJyksXG4gICAgfX1cbiAgLz5cbilcblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gbWFrZUhlYWRXaXRoTWV0YShzdGF0ZSkge1xuICBjb25zdCB7XG4gICAgaGVhZCxcbiAgICByb3V0ZSxcbiAgICBjbGllbnRTY3JpcHRzLFxuICAgIGNvbmZpZyxcbiAgICBjbGllbnRTdHlsZVNoZWV0cyxcbiAgICBjbGllbnRDc3MsXG4gIH0gPSBzdGF0ZVxuXG4gIGNvbnN0IHBsdWdpbkhlYWRzID0gYXdhaXQgcGx1Z2lucy5oZWFkRWxlbWVudHMoW10sIHN0YXRlKVxuXG4gIHJldHVybiAoeyBjaGlsZHJlbiwgLi4ucmVzdCB9KSA9PiB7XG4gICAgY29uc3QgcmVuZGVyTGlua0NTUyA9ICFyb3V0ZS5yZWRpcmVjdCAmJiAhY29uZmlnLmlubGluZUNzc1xuXG4gICAgY29uc3QgdXNlSGVsbWV0VGl0bGUgPVxuICAgICAgaGVhZC50aXRsZSAmJiBoZWFkLnRpdGxlWzBdICYmIGhlYWQudGl0bGVbMF0ucHJvcHMuY2hpbGRyZW4gIT09ICcnXG5cbiAgICBsZXQgY2hpbGRyZW5BcnJheSA9IFJlYWN0LkNoaWxkcmVuLnRvQXJyYXkoY2hpbGRyZW4pXG5cbiAgICBpZiAodXNlSGVsbWV0VGl0bGUpIHtcbiAgICAgIGhlYWQudGl0bGVbMF0gPSBSZWFjdC5jbG9uZUVsZW1lbnQoaGVhZC50aXRsZVswXSwgeyBrZXk6ICd0aXRsZScgfSlcbiAgICAgIGNoaWxkcmVuQXJyYXkgPSBjaGlsZHJlbkFycmF5LmZpbHRlcihjaGlsZCA9PiB7XG4gICAgICAgIGlmIChjaGlsZC50eXBlID09PSAndGl0bGUnKSB7XG4gICAgICAgICAgLy8gRmlsdGVyIG91dCB0aGUgdGl0bGUgb2YgdGhlIERvY3VtZW50IGluIHN0YXRpYy5jb25maWcuanNcbiAgICAgICAgICAvLyBpZiB0aGVyZSBpcyBhIGhlbG1ldCB0aXRsZSBvbiB0aGlzIHJvdXRlXG4gICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29uc3QgY2hpbGRyZW5DU1MgPSBjaGlsZHJlbkFycmF5LmZpbHRlcihjaGlsZCA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIGNoaWxkLnR5cGUgPT09ICdsaW5rJyAmJlxuICAgICAgICBjaGlsZC5wcm9wcyAmJlxuICAgICAgICBjaGlsZC5wcm9wcy5yZWwgPT09ICdzdHlsZXNoZWV0J1xuICAgICAgKSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9XG4gICAgICBpZiAoY2hpbGQudHlwZSA9PT0gJ3N0eWxlJykge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfSlcblxuICAgIGNvbnN0IGNoaWxkcmVuSlMgPSBjaGlsZHJlbkFycmF5LmZpbHRlcihjaGlsZCA9PiBjaGlsZC50eXBlID09PSAnc2NyaXB0JylcbiAgICBjaGlsZHJlbkFycmF5ID0gY2hpbGRyZW5BcnJheS5maWx0ZXIoY2hpbGQgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICBjaGlsZC50eXBlID09PSAnbGluaycgJiZcbiAgICAgICAgY2hpbGQucHJvcHMgJiZcbiAgICAgICAgY2hpbGQucHJvcHMucmVsID09PSAnc3R5bGVzaGVldCdcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICAgIGlmIChjaGlsZC50eXBlID09PSAnc3R5bGUnKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgICAgaWYgKGNoaWxkLnR5cGUgPT09ICdzY3JpcHQnKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWVcbiAgICB9KVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxoZWFkIHsuLi5yZXN0fT5cbiAgICAgICAgPG1ldGEgbmFtZT1cImdlbmVyYXRvclwiIGNvbnRlbnQ9XCJSZWFjdCBTdGF0aWNcIiAvPlxuICAgICAgICB7aGVhZC5iYXNlfVxuICAgICAgICB7dXNlSGVsbWV0VGl0bGUgJiYgaGVhZC50aXRsZX1cbiAgICAgICAge2hlYWQubWV0YX1cbiAgICAgICAge2NoaWxkcmVuSlN9XG4gICAgICAgIHshcm91dGUucmVkaXJlY3QgJiZcbiAgICAgICAgICBjbGllbnRTY3JpcHRzLm1hcChzY3JpcHQgPT4gKFxuICAgICAgICAgICAgPGxpbmtcbiAgICAgICAgICAgICAga2V5PXtgY2xpZW50U2NyaXB0XyR7c2NyaXB0fWB9XG4gICAgICAgICAgICAgIHJlbD1cInByZWxvYWRcIlxuICAgICAgICAgICAgICBhcz1cInNjcmlwdFwiXG4gICAgICAgICAgICAgIGhyZWY9e21ha2VQYXRoQWJzb2x1dGUoXG4gICAgICAgICAgICAgICAgcGF0aEpvaW4ocHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX0FTU0VUU19QQVRILCBzY3JpcHQpXG4gICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICkpfVxuICAgICAgICB7Y2hpbGRyZW5DU1N9XG4gICAgICAgIHtyZW5kZXJMaW5rQ1NTICYmXG4gICAgICAgICAgY2xpZW50U3R5bGVTaGVldHMucmVkdWNlKChtZW1vLCBzdHlsZVNoZWV0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBocmVmID0gbWFrZVBhdGhBYnNvbHV0ZShcbiAgICAgICAgICAgICAgcGF0aEpvaW4ocHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX0FTU0VUU19QQVRILCBzdHlsZVNoZWV0KVxuICAgICAgICAgICAgKVxuXG4gICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAuLi5tZW1vLFxuICAgICAgICAgICAgICA8bGlua1xuICAgICAgICAgICAgICAgIGtleT17YGNsaWVudFN0eWxlU2hlZXRQcmVsb2FkXyR7c3R5bGVTaGVldH1gfVxuICAgICAgICAgICAgICAgIHJlbD1cInByZWxvYWRcIlxuICAgICAgICAgICAgICAgIGFzPVwic3R5bGVcIlxuICAgICAgICAgICAgICAgIGhyZWY9e2hyZWZ9XG4gICAgICAgICAgICAgIC8+LFxuICAgICAgICAgICAgICA8bGlua1xuICAgICAgICAgICAgICAgIGtleT17YGNsaWVudFN0eWxlU2hlZXRfJHtzdHlsZVNoZWV0fWB9XG4gICAgICAgICAgICAgICAgcmVsPVwic3R5bGVzaGVldFwiXG4gICAgICAgICAgICAgICAgaHJlZj17aHJlZn1cbiAgICAgICAgICAgICAgLz4sXG4gICAgICAgICAgICBdXG4gICAgICAgICAgfSwgW10pfVxuICAgICAgICB7aGVhZC5saW5rfVxuICAgICAgICB7aGVhZC5ub3NjcmlwdH1cbiAgICAgICAge2hlYWQuc2NyaXB0fVxuICAgICAgICB7Y29uZmlnLmlubGluZUNzcyAmJiA8SW5saW5lU3R5bGUgY2xpZW50Q3NzPXtjbGllbnRDc3N9IC8+fVxuICAgICAgICB7aGVhZC5zdHlsZX1cbiAgICAgICAge3BsdWdpbkhlYWRzfVxuICAgICAgICB7Y2hpbGRyZW5BcnJheX1cbiAgICAgIDwvaGVhZD5cbiAgICApXG4gIH1cbn1cbiJdfQ==