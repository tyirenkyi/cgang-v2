"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _webpack = _interopRequireDefault(require("webpack"));

var _path = _interopRequireDefault(require("path"));

var _caseSensitivePathsWebpackPlugin = _interopRequireDefault(require("case-sensitive-paths-webpack-plugin"));

var _webpackBundleAnalyzer = require("webpack-bundle-analyzer");

var _terserWebpackPlugin = _interopRequireDefault(require("terser-webpack-plugin"));

var _webpackNodeExternals = _interopRequireDefault(require("webpack-node-externals"));

var _extractCssChunksWebpackPlugin = _interopRequireDefault(require("extract-css-chunks-webpack-plugin"));

var _optimizeCssAssetsWebpackPlugin = _interopRequireDefault(require("optimize-css-assets-webpack-plugin"));

var _resolveFrom = _interopRequireDefault(require("resolve-from"));

var _rules = _interopRequireDefault(require("./rules"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function common(state) {
  var analyze = state.analyze,
      config = state.config,
      debug = state.debug;
  var _config$paths = config.paths,
      ROOT = _config$paths.ROOT,
      DIST = _config$paths.DIST,
      NODE_MODULES = _config$paths.NODE_MODULES,
      SRC = _config$paths.SRC,
      ASSETS = _config$paths.ASSETS;
  process.env.REACT_STATIC_ENTRY_PATH = config.entry;
  process.env.REACT_STATIC_SITE_ROOT = config.siteRoot;
  process.env.REACT_STATIC_BASE_PATH = config.basePath;
  process.env.REACT_STATIC_PUBLIC_PATH = config.publicPath;
  process.env.REACT_STATIC_ASSETS_PATH = config.assetsPath;

  if (!DIST.startsWith(ROOT)) {
    // we build outside of project dir, so reset some paths
    process.env.REACT_STATIC_ASSETS_PATH = config.assetsPath.replace(DIST, '');
  }

  var splitChunks = {
    chunks: 'all',
    minSize: 10000,
    minChunks: 1,
    maxAsyncRequests: 5,
    maxInitialRequests: 5,
    automaticNameDelimiter: '~',
    name: true,
    cacheGroups: {
      vendors: {
        test: /[\\/]node_modules[\\/]/,
        priority: -10,
        chunks: 'all'
      },
      "default": {
        minChunks: 2,
        priority: -20,
        reuseExistingChunk: true
      }
    }
  };
  var extrackCSSChunks = new _extractCssChunksWebpackPlugin["default"]({
    filename: '[name].[chunkHash:8].css',
    chunkFilename: '[id].[chunkHash:8].css'
  });

  if (!config.extractCssChunks) {
    splitChunks.cacheGroups = {
      styles: {
        name: 'styles',
        test: /\.css$/,
        chunks: 'all',
        enforce: true
      }
    };
    extrackCSSChunks = new _extractCssChunksWebpackPlugin["default"]({
      filename: '[name].[chunkHash:8].css'
    });
  }

  return {
    mode: 'production',
    context: _path["default"].resolve(__dirname, '../../../node_modules'),
    entry: config.disableRuntime ? config.entry : [require.resolve('../../bootstrapPlugins'), require.resolve('../../bootstrapTemplates'), require.resolve('../../bootstrapApp')],
    output: {
      filename: '[name].[hash:8].js',
      // dont use chunkhash, its not a chunk
      chunkFilename: 'templates/[name].[chunkHash:8].js',
      path: ASSETS,
      publicPath: process.env.REACT_STATIC_PUBLIC_PATH || '/'
    },
    optimization: {
      sideEffects: true,
      minimize: true,
      minimizer: [new _terserWebpackPlugin["default"](_objectSpread({
        cache: true,
        parallel: true,
        exclude: /\.min\.js/
      }, config.terser, {
        sourceMap: config.productionSourceMaps || config.terser.sourceMap || debug,
        terserOptions: _objectSpread({
          ie8: false
        }, config.terser.terserOptions, {
          mangle: _objectSpread({
            safari10: true
          }, config.terser.terserOptions.mangle),
          parse: _objectSpread({
            ecma: 8
          }, config.terser.terserOptions.parse),
          compress: _objectSpread({
            ecma: 5
          }, config.terser.terserOptions.compress),
          output: _objectSpread({
            ecma: 5
          }, config.terser.terserOptions.output)
        })
      })), new _optimizeCssAssetsWebpackPlugin["default"]({})],
      splitChunks: splitChunks
    },
    performance: {
      maxEntrypointSize: 300000
    },
    module: {
      rules: (0, _rules["default"])({
        config: config,
        stage: 'prod',
        isNode: false
      }),
      strictExportPresence: true
    },
    resolve: {
      modules: [NODE_MODULES, SRC, DIST].concat((0, _toConsumableArray2["default"])([NODE_MODULES, SRC, DIST].map(function (d) {
        return DIST.startsWith(ROOT) ? _path["default"].resolve(__dirname, d) : _path["default"].resolve(d);
      })), ['node_modules']),
      extensions: ['.wasm', '.mjs', '.js', '.json', '.jsx'],
      alias: {
        react$: (0, _resolveFrom["default"])(config.paths.NODE_MODULES, 'react'),
        'react-dom$': (0, _resolveFrom["default"])(config.paths.NODE_MODULES, 'react-dom'),
        'react-universal-component': (0, _resolveFrom["default"])(__dirname, 'react-universal-component')
      }
    },
    externals: [],
    target: undefined,
    plugins: [new _webpack["default"].EnvironmentPlugin(process.env), extrackCSSChunks, new _caseSensitivePathsWebpackPlugin["default"](), analyze && new _webpackBundleAnalyzer.BundleAnalyzerPlugin()].filter(function (d) {
      return d;
    }),
    devtool: debug || config.productionSourceMaps ? 'source-map' : false
  };
}

function _default(state) {
  var stage = state.stage,
      paths = state.config.paths;
  var result = common(state);
  if (stage !== 'node') return result; // Node only!!!

  result.output.filename = 'static-app.js';
  result.output.path = paths.ARTIFACTS;
  result.output.libraryTarget = 'umd';
  result.optimization.minimize = false;
  result.optimization.minimizer = [];
  result.target = 'node';
  result.devtool = false;
  result.externals = [new RegExp("".concat(paths.PLUGINS)), function (context, request, callback) {
    var resolved = _path["default"].resolve(context, request);

    if ([/react-static(\\|\/)lib(\\|\/)browser/, /webpack-flush-chunks/].some(function (d) {
      return d.test(resolved);
    })) {
      return callback(null, "commonjs ".concat(resolved));
    }

    callback();
  }, (0, _webpackNodeExternals["default"])()];
  result.module.rules = (0, _rules["default"])(state);
  result.plugins = [new _webpack["default"].EnvironmentPlugin(process.env), new _caseSensitivePathsWebpackPlugin["default"](), new _webpack["default"].optimize.LimitChunkCountPlugin({
    maxChunks: 1
  })];
  return result;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdGF0aWMvd2VicGFjay93ZWJwYWNrLmNvbmZpZy5wcm9kLmpzIl0sIm5hbWVzIjpbImNvbW1vbiIsInN0YXRlIiwiYW5hbHl6ZSIsImNvbmZpZyIsImRlYnVnIiwicGF0aHMiLCJST09UIiwiRElTVCIsIk5PREVfTU9EVUxFUyIsIlNSQyIsIkFTU0VUUyIsInByb2Nlc3MiLCJlbnYiLCJSRUFDVF9TVEFUSUNfRU5UUllfUEFUSCIsImVudHJ5IiwiUkVBQ1RfU1RBVElDX1NJVEVfUk9PVCIsInNpdGVSb290IiwiUkVBQ1RfU1RBVElDX0JBU0VfUEFUSCIsImJhc2VQYXRoIiwiUkVBQ1RfU1RBVElDX1BVQkxJQ19QQVRIIiwicHVibGljUGF0aCIsIlJFQUNUX1NUQVRJQ19BU1NFVFNfUEFUSCIsImFzc2V0c1BhdGgiLCJzdGFydHNXaXRoIiwicmVwbGFjZSIsInNwbGl0Q2h1bmtzIiwiY2h1bmtzIiwibWluU2l6ZSIsIm1pbkNodW5rcyIsIm1heEFzeW5jUmVxdWVzdHMiLCJtYXhJbml0aWFsUmVxdWVzdHMiLCJhdXRvbWF0aWNOYW1lRGVsaW1pdGVyIiwibmFtZSIsImNhY2hlR3JvdXBzIiwidmVuZG9ycyIsInRlc3QiLCJwcmlvcml0eSIsInJldXNlRXhpc3RpbmdDaHVuayIsImV4dHJhY2tDU1NDaHVua3MiLCJFeHRyYWN0Q3NzQ2h1bmtzIiwiZmlsZW5hbWUiLCJjaHVua0ZpbGVuYW1lIiwiZXh0cmFjdENzc0NodW5rcyIsInN0eWxlcyIsImVuZm9yY2UiLCJtb2RlIiwiY29udGV4dCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZGlzYWJsZVJ1bnRpbWUiLCJyZXF1aXJlIiwib3V0cHV0Iiwib3B0aW1pemF0aW9uIiwic2lkZUVmZmVjdHMiLCJtaW5pbWl6ZSIsIm1pbmltaXplciIsIlRlcnNlclBsdWdpbiIsImNhY2hlIiwicGFyYWxsZWwiLCJleGNsdWRlIiwidGVyc2VyIiwic291cmNlTWFwIiwicHJvZHVjdGlvblNvdXJjZU1hcHMiLCJ0ZXJzZXJPcHRpb25zIiwiaWU4IiwibWFuZ2xlIiwic2FmYXJpMTAiLCJwYXJzZSIsImVjbWEiLCJjb21wcmVzcyIsIk9wdGltaXplQ1NTQXNzZXRzUGx1Z2luIiwicGVyZm9ybWFuY2UiLCJtYXhFbnRyeXBvaW50U2l6ZSIsIm1vZHVsZSIsInJ1bGVzIiwic3RhZ2UiLCJpc05vZGUiLCJzdHJpY3RFeHBvcnRQcmVzZW5jZSIsIm1vZHVsZXMiLCJtYXAiLCJkIiwiZXh0ZW5zaW9ucyIsImFsaWFzIiwicmVhY3QkIiwiZXh0ZXJuYWxzIiwidGFyZ2V0IiwidW5kZWZpbmVkIiwicGx1Z2lucyIsIndlYnBhY2siLCJFbnZpcm9ubWVudFBsdWdpbiIsIkNhc2VTZW5zaXRpdmVQYXRoc1BsdWdpbiIsIkJ1bmRsZUFuYWx5emVyUGx1Z2luIiwiZmlsdGVyIiwiZGV2dG9vbCIsInJlc3VsdCIsIkFSVElGQUNUUyIsImxpYnJhcnlUYXJnZXQiLCJSZWdFeHAiLCJQTFVHSU5TIiwicmVxdWVzdCIsImNhbGxiYWNrIiwicmVzb2x2ZWQiLCJzb21lIiwib3B0aW1pemUiLCJMaW1pdENodW5rQ291bnRQbHVnaW4iLCJtYXhDaHVua3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7O0FBRUEsU0FBU0EsTUFBVCxDQUFnQkMsS0FBaEIsRUFBdUI7QUFBQSxNQUNiQyxPQURhLEdBQ2NELEtBRGQsQ0FDYkMsT0FEYTtBQUFBLE1BQ0pDLE1BREksR0FDY0YsS0FEZCxDQUNKRSxNQURJO0FBQUEsTUFDSUMsS0FESixHQUNjSCxLQURkLENBQ0lHLEtBREo7QUFBQSxzQkFFNkJELE1BQU0sQ0FBQ0UsS0FGcEM7QUFBQSxNQUViQyxJQUZhLGlCQUViQSxJQUZhO0FBQUEsTUFFUEMsSUFGTyxpQkFFUEEsSUFGTztBQUFBLE1BRURDLFlBRkMsaUJBRURBLFlBRkM7QUFBQSxNQUVhQyxHQUZi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QUMxQyxZQUFQLENBQW9CRyxTQUFwQixHQUFnQyxFQUFoQztBQUNBdUMsRUFBQUEsTUFBTSxDQUFDVCxNQUFQLEdBQWdCLE1BQWhCO0FBQ0FTLEVBQUFBLE1BQU0sQ0FBQ0QsT0FBUCxHQUFpQixLQUFqQjtBQUNBQyxFQUFBQSxNQUFNLENBQUNWLFNBQVAsR0FBbUIsQ0FDakIsSUFBSWEsTUFBSixXQUFjN0YsS0FBSyxDQUFDOEYsT0FBcEIsRUFEaUIsRUFFakIsVUFBQ3JELE9BQUQsRUFBVXNELE9BQVYsRUFBbUJDLFFBQW5CLEVBQWdDO0FBQzlCLFFBQU1DLFFBQVEsR0FBR3ZELGlCQUFLQyxPQUFMLENBQWFGLE9BQWIsRUFBc0JzRCxPQUF0QixDQUFqQjs7QUFDQSxRQUNFLENBQUMsc0NBQUQsRUFBeUMsc0JBQXpDLEVBQWlFRyxJQUFqRSxDQUNFLFVBQUF0QixDQUFDO0FBQUEsYUFBSUEsQ0FBQyxDQUFDOUMsSUFBRixDQUFPbUUsUUFBUCxDQUFKO0FBQUEsS0FESCxDQURGLEVBSUU7QUFDQSxhQUFPRCxRQUFRLENBQUMsSUFBRCxxQkFBbUJDLFFBQW5CLEVBQWY7QUFDRDs7QUFDREQsSUFBQUEsUUFBUTtBQUNULEdBWmdCLEVBYWpCLHVDQWJpQixDQUFuQjtBQWVBTixFQUFBQSxNQUFNLENBQUNyQixNQUFQLENBQWNDLEtBQWQsR0FBc0IsdUJBQU0xRSxLQUFOLENBQXRCO0FBQ0E4RixFQUFBQSxNQUFNLENBQUNQLE9BQVAsR0FBaUIsQ0FDZixJQUFJQyxvQkFBUUMsaUJBQVosQ0FBOEIvRSxPQUFPLENBQUNDLEdBQXRDLENBRGUsRUFFZixJQUFJK0UsMkNBQUosRUFGZSxFQUdmLElBQUlGLG9CQUFRZSxRQUFSLENBQWlCQyxxQkFBckIsQ0FBMkM7QUFDekNDLElBQUFBLFNBQVMsRUFBRTtBQUQ4QixHQUEzQyxDQUhlLENBQWpCO0FBT0EsU0FBT1gsTUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHdlYnBhY2sgZnJvbSAnd2VicGFjaydcclxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcclxuaW1wb3J0IENhc2VTZW5zaXRpdmVQYXRoc1BsdWdpbiBmcm9tICdjYXNlLXNlbnNpdGl2ZS1wYXRocy13ZWJwYWNrLXBsdWdpbidcclxuaW1wb3J0IHsgQnVuZGxlQW5hbHl6ZXJQbHVnaW4gfSBmcm9tICd3ZWJwYWNrLWJ1bmRsZS1hbmFseXplcidcclxuaW1wb3J0IFRlcnNlclBsdWdpbiBmcm9tICd0ZXJzZXItd2VicGFjay1wbHVnaW4nXHJcbmltcG9ydCBub2RlRXh0ZXJuYWxzIGZyb20gJ3dlYnBhY2stbm9kZS1leHRlcm5hbHMnXHJcbmltcG9ydCBFeHRyYWN0Q3NzQ2h1bmtzIGZyb20gJ2V4dHJhY3QtY3NzLWNodW5rcy13ZWJwYWNrLXBsdWdpbidcclxuaW1wb3J0IE9wdGltaXplQ1NTQXNzZXRzUGx1Z2luIGZyb20gJ29wdGltaXplLWNzcy1hc3NldHMtd2VicGFjay1wbHVnaW4nXHJcbmltcG9ydCByZXNvbHZlRnJvbSBmcm9tICdyZXNvbHZlLWZyb20nXHJcbi8vXHJcbmltcG9ydCBydWxlcyBmcm9tICcuL3J1bGVzJ1xyXG5cclxuZnVuY3Rpb24gY29tbW9uKHN0YXRlKSB7XHJcbiAgY29uc3QgeyBhbmFseXplLCBjb25maWcsIGRlYnVnIH0gPSBzdGF0ZVxyXG4gIGNvbnN0IHsgUk9PVCwgRElTVCwgTk9ERV9NT0RVTEVTLCBTUkMsIEFTU0VUUyB9ID0gY29uZmlnLnBhdGhzXHJcblxyXG4gIHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19FTlRSWV9QQVRIID0gY29uZmlnLmVudHJ5XHJcbiAgcHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX1NJVEVfUk9PVCA9IGNvbmZpZy5zaXRlUm9vdFxyXG4gIHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19CQVNFX1BBVEggPSBjb25maWcuYmFzZVBhdGhcclxuICBwcm9jZXNzLmVudi5SRUFDVF9TVEFUSUNfUFVCTElDX1BBVEggPSBjb25maWcucHVibGljUGF0aFxyXG4gIHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19BU1NFVFNfUEFUSCA9IGNvbmZpZy5hc3NldHNQYXRoXHJcblxyXG4gIGlmICghRElTVC5zdGFydHNXaXRoKFJPT1QpKSB7XHJcbiAgICAvLyB3ZSBidWlsZCBvdXRzaWRlIG9mIHByb2plY3QgZGlyLCBzbyByZXNldCBzb21lIHBhdGhzXHJcbiAgICBwcm9jZXNzLmVudi5SRUFDVF9TVEFUSUNfQVNTRVRTX1BBVEggPSBjb25maWcuYXNzZXRzUGF0aC5yZXBsYWNlKERJU1QsICcnKVxyXG4gIH1cclxuXHJcbiAgY29uc3Qgc3BsaXRDaHVua3MgPSB7XHJcbiAgICBjaHVua3M6ICdhbGwnLFxyXG4gICAgbWluU2l6ZTogMTAwMDAsXHJcbiAgICBtaW5DaHVua3M6IDEsXHJcbiAgICBtYXhBc3luY1JlcXVlc3RzOiA1LFxyXG4gICAgbWF4SW5pdGlhbFJlcXVlc3RzOiA1LFxyXG4gICAgYXV0b21hdGljTmFtZURlbGltaXRlcjogJ34nLFxyXG4gICAgbmFtZTogdHJ1ZSxcclxuICAgIGNhY2hlR3JvdXBzOiB7XHJcbiAgICAgIHZlbmRvcnM6IHtcclxuICAgICAgICB0ZXN0OiAvW1xcXFwvXW5vZGVfbW9kdWxlc1tcXFxcL10vLFxyXG4gICAgICAgIHByaW9yaXR5OiAtMTAsXHJcbiAgICAgICAgY2h1bmtzOiAnYWxsJyxcclxuICAgICAgfSxcclxuICAgICAgZGVmYXVsdDoge1xyXG4gICAgICAgIG1pbkNodW5rczogMixcclxuICAgICAgICBwcmlvcml0eTogLTIwLFxyXG4gICAgICAgIHJldXNlRXhpc3RpbmdDaHVuazogdHJ1ZSxcclxuICAgICAgfSxcclxuICAgIH0sXHJcbiAgfVxyXG5cclxuICBsZXQgZXh0cmFja0NTU0NodW5rcyA9IG5ldyBFeHRyYWN0Q3NzQ2h1bmtzKHtcclxuICAgIGZpbGVuYW1lOiAnW25hbWVdLltjaHVua0hhc2g6OF0uY3NzJyxcclxuICAgIGNodW5rRmlsZW5hbWU6ICdbaWRdLltjaHVua0hhc2g6OF0uY3NzJyxcclxuICB9KVxyXG5cclxuICBpZiAoIWNvbmZpZy5leHRyYWN0Q3NzQ2h1bmtzKSB7XHJcbiAgICBzcGxpdENodW5rcy5jYWNoZUdyb3VwcyA9IHtcclxuICAgICAgc3R5bGVzOiB7XHJcbiAgICAgICAgbmFtZTogJ3N0eWxlcycsXHJcbiAgICAgICAgdGVzdDogL1xcLmNzcyQvLFxyXG4gICAgICAgIGNodW5rczogJ2FsbCcsXHJcbiAgICAgICAgZW5mb3JjZTogdHJ1ZSxcclxuICAgICAgfSxcclxuICAgIH1cclxuICAgIGV4dHJhY2tDU1NDaHVua3MgPSBuZXcgRXh0cmFjdENzc0NodW5rcyh7XHJcbiAgICAgIGZpbGVuYW1lOiAnW25hbWVdLltjaHVua0hhc2g6OF0uY3NzJyxcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgbW9kZTogJ3Byb2R1Y3Rpb24nLFxyXG4gICAgY29udGV4dDogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uLy4uLy4uL25vZGVfbW9kdWxlcycpLFxyXG4gICAgZW50cnk6IGNvbmZpZy5kaXNhYmxlUnVudGltZVxyXG4gICAgICA/IGNvbmZpZy5lbnRyeVxyXG4gICAgICA6IFtcclxuICAgICAgICAgIHJlcXVpcmUucmVzb2x2ZSgnLi4vLi4vYm9vdHN0cmFwUGx1Z2lucycpLFxyXG4gICAgICAgICAgcmVxdWlyZS5yZXNvbHZlKCcuLi8uLi9ib290c3RyYXBUZW1wbGF0ZXMnKSxcclxuICAgICAgICAgIHJlcXVpcmUucmVzb2x2ZSgnLi4vLi4vYm9vdHN0cmFwQXBwJyksXHJcbiAgICAgICAgXSxcclxuICAgIG91dHB1dDoge1xyXG4gICAgICBmaWxlbmFtZTogJ1tuYW1lXS5baGFzaDo4XS5qcycsIC8vIGRvbnQgdXNlIGNodW5raGFzaCwgaXRzIG5vdCBhIGNodW5rXHJcbiAgICAgIGNodW5rRmlsZW5hbWU6ICd0ZW1wbGF0ZXMvW25hbWVdLltjaHVua0hhc2g6OF0uanMnLFxyXG4gICAgICBwYXRoOiBBU1NFVFMsXHJcbiAgICAgIHB1YmxpY1BhdGg6IHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19QVUJMSUNfUEFUSCB8fCAnLycsXHJcbiAgICB9LFxyXG4gICAgb3B0aW1pemF0aW9uOiB7XHJcbiAgICAgIHNpZGVFZmZlY3RzOiB0cnVlLFxyXG4gICAgICBtaW5pbWl6ZTogdHJ1ZSxcclxuICAgICAgbWluaW1pemVyOiBbXHJcbiAgICAgICAgbmV3IFRlcnNlclBsdWdpbih7XHJcbiAgICAgICAgICBjYWNoZTogdHJ1ZSxcclxuICAgICAgICAgIHBhcmFsbGVsOiB0cnVlLFxyXG4gICAgICAgICAgZXhjbHVkZTogL1xcLm1pblxcLmpzLyxcclxuICAgICAgICAgIC4uLmNvbmZpZy50ZXJzZXIsXHJcbiAgICAgICAgICBzb3VyY2VNYXA6XHJcbiAgICAgICAgICAgIGNvbmZpZy5wcm9kdWN0aW9uU291cmNlTWFwcyB8fCBjb25maWcudGVyc2VyLnNvdXJjZU1hcCB8fCBkZWJ1ZyxcclxuICAgICAgICAgIHRlcnNlck9wdGlvbnM6IHtcclxuICAgICAgICAgICAgaWU4OiBmYWxzZSxcclxuICAgICAgICAgICAgLi4uY29uZmlnLnRlcnNlci50ZXJzZXJPcHRpb25zLFxyXG4gICAgICAgICAgICBtYW5nbGU6IHsgc2FmYXJpMTA6IHRydWUsIC4uLmNvbmZpZy50ZXJzZXIudGVyc2VyT3B0aW9ucy5tYW5nbGUgfSxcclxuICAgICAgICAgICAgcGFyc2U6IHsgZWNtYTogOCwgLi4uY29uZmlnLnRlcnNlci50ZXJzZXJPcHRpb25zLnBhcnNlIH0sXHJcbiAgICAgICAgICAgIGNvbXByZXNzOiB7IGVjbWE6IDUsIC4uLmNvbmZpZy50ZXJzZXIudGVyc2VyT3B0aW9ucy5jb21wcmVzcyB9LFxyXG4gICAgICAgICAgICBvdXRwdXQ6IHsgZWNtYTogNSwgLi4uY29uZmlnLnRlcnNlci50ZXJzZXJPcHRpb25zLm91dHB1dCB9LFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9KSxcclxuICAgICAgICBuZXcgT3B0aW1pemVDU1NBc3NldHNQbHVnaW4oe30pLFxyXG4gICAgICBdLFxyXG4gICAgICBzcGxpdENodW5rcyxcclxuICAgIH0sXHJcbiAgICBwZXJmb3JtYW5jZToge1xyXG4gICAgICBtYXhFbnRyeXBvaW50U2l6ZTogMzAwMDAwLFxyXG4gICAgfSxcclxuICAgIG1vZHVsZToge1xyXG4gICAgICBydWxlczogcnVsZXMoeyBjb25maWcsIHN0YWdlOiAncHJvZCcsIGlzTm9kZTogZmFsc2UgfSksXHJcbiAgICAgIHN0cmljdEV4cG9ydFByZXNlbmNlOiB0cnVlLFxyXG4gICAgfSxcclxuICAgIHJlc29sdmU6IHtcclxuICAgICAgbW9kdWxlczogW1xyXG4gICAgICAgIE5PREVfTU9EVUxFUyxcclxuICAgICAgICBTUkMsXHJcbiAgICAgICAgRElTVCxcclxuICAgICAgICAuLi5bTk9ERV9NT0RVTEVTLCBTUkMsIERJU1RdLm1hcChkID0+XHJcbiAgICAgICAgICBESVNULnN0YXJ0c1dpdGgoUk9PVCkgPyBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBkKSA6IHBhdGgucmVzb2x2ZShkKVxyXG4gICAgICAgICksXHJcbiAgICAgICAgJ25vZGVfbW9kdWxlcycsXHJcbiAgICAgIF0sXHJcbiAgICAgIGV4dGVuc2lvbnM6IFsnLndhc20nLCAnLm1qcycsICcuanMnLCAnLmpzb24nLCAnLmpzeCddLFxyXG4gICAgICBhbGlhczoge1xyXG4gICAgICAgIHJlYWN0JDogcmVzb2x2ZUZyb20oY29uZmlnLnBhdGhzLk5PREVfTU9EVUxFUywgJ3JlYWN0JyksXHJcbiAgICAgICAgJ3JlYWN0LWRvbSQnOiByZXNvbHZlRnJvbShjb25maWcucGF0aHMuTk9ERV9NT0RVTEVTLCAncmVhY3QtZG9tJyksXHJcbiAgICAgICAgJ3JlYWN0LXVuaXZlcnNhbC1jb21wb25lbnQnOiByZXNvbHZlRnJvbShcclxuICAgICAgICAgIF9fZGlybmFtZSxcclxuICAgICAgICAgICdyZWFjdC11bml2ZXJzYWwtY29tcG9uZW50J1xyXG4gICAgICAgICksXHJcbiAgICAgIH0sXHJcbiAgICB9LFxyXG4gICAgZXh0ZXJuYWxzOiBbXSxcclxuICAgIHRhcmdldDogdW5kZWZpbmVkLFxyXG4gICAgcGx1Z2luczogW1xyXG4gICAgICBuZXcgd2VicGFjay5FbnZpcm9ubWVudFBsdWdpbihwcm9jZXNzLmVudiksXHJcbiAgICAgIGV4dHJhY2tDU1NDaHVua3MsXHJcbiAgICAgIG5ldyBDYXNlU2Vuc2l0aXZlUGF0aHNQbHVnaW4oKSxcclxuICAgICAgYW5hbHl6ZSAmJiBuZXcgQnVuZGxlQW5hbHl6ZXJQbHVnaW4oKSxcclxuICAgIF0uZmlsdGVyKGQgPT4gZCksXHJcbiAgICBkZXZ0b29sOiBkZWJ1ZyB8fCBjb25maWcucHJvZHVjdGlvblNvdXJjZU1hcHMgPyAnc291cmNlLW1hcCcgOiBmYWxzZSxcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uKHN0YXRlKSB7XHJcbiAgY29uc3Qge1xyXG4gICAgc3RhZ2UsXHJcbiAgICBjb25maWc6IHsgcGF0aHMgfSxcclxuICB9ID0gc3RhdGVcclxuXHJcbiAgY29uc3QgcmVzdWx0ID0gY29tbW9uKHN0YXRlKVxyXG4gIGlmIChzdGFnZSAhPT0gJ25vZGUnKSByZXR1cm4gcmVzdWx0XHJcblxyXG4gIC8vIE5vZGUgb25seSEhIVxyXG4gIHJlc3VsdC5vdXRwdXQuZmlsZW5hbWUgPSAnc3RhdGljLWFwcC5qcydcclxuICByZXN1bHQub3V0cHV0LnBhdGggPSBwYXRocy5BUlRJRkFDVFNcclxuICByZXN1bHQub3V0cHV0LmxpYnJhcnlUYXJnZXQgPSAndW1kJ1xyXG4gIHJlc3VsdC5vcHRpbWl6YXRpb24ubWluaW1pemUgPSBmYWxzZVxyXG4gIHJlc3VsdC5vcHRpbWl6YXRpb24ubWluaW1pemVyID0gW11cclxuICByZXN1bHQudGFyZ2V0ID0gJ25vZGUnXHJcbiAgcmVzdWx0LmRldnRvb2wgPSBmYWxzZVxyXG4gIHJlc3VsdC5leHRlcm5hbHMgPSBbXHJcbiAgICBuZXcgUmVnRXhwKGAke3BhdGhzLlBMVUdJTlN9YCksXHJcbiAgICAoY29udGV4dCwgcmVxdWVzdCwgY2FsbGJhY2spID0+IHtcclxuICAgICAgY29uc3QgcmVzb2x2ZWQgPSBwYXRoLnJlc29sdmUoY29udGV4dCwgcmVxdWVzdClcclxuICAgICAgaWYgKFxyXG4gICAgICAgIFsvcmVhY3Qtc3RhdGljKFxcXFx8XFwvKWxpYihcXFxcfFxcLylicm93c2VyLywgL3dlYnBhY2stZmx1c2gtY2h1bmtzL10uc29tZShcclxuICAgICAgICAgIGQgPT4gZC50ZXN0KHJlc29sdmVkKVxyXG4gICAgICAgIClcclxuICAgICAgKSB7XHJcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIGBjb21tb25qcyAke3Jlc29sdmVkfWApXHJcbiAgICAgIH1cclxuICAgICAgY2FsbGJhY2soKVxyXG4gICAgfSxcclxuICAgIG5vZGVFeHRlcm5hbHMoKSxcclxuICBdXHJcbiAgcmVzdWx0Lm1vZHVsZS5ydWxlcyA9IHJ1bGVzKHN0YXRlKVxyXG4gIHJlc3VsdC5wbHVnaW5zID0gW1xyXG4gICAgbmV3IHdlYnBhY2suRW52aXJvbm1lbnRQbHVnaW4ocHJvY2Vzcy5lbnYpLFxyXG4gICAgbmV3IENhc2VTZW5zaXRpdmVQYXRoc1BsdWdpbigpLFxyXG4gICAgbmV3IHdlYnBhY2sub3B0aW1pemUuTGltaXRDaHVua0NvdW50UGx1Z2luKHtcclxuICAgICAgbWF4Q2h1bmtzOiAxLFxyXG4gICAgfSksXHJcbiAgXVxyXG4gIHJldHVybiByZXN1bHRcclxufVxyXG4iXX0=