"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _react = _interopRequireDefault(require("react"));

var _server = require("react-dom/server");

var _reactHelmet = _interopRequireDefault(require("react-helmet"));

var _reactUniversalComponent = require("react-universal-component");

var _webpackFlushChunks = _interopRequireDefault(require("webpack-flush-chunks"));

var _path = _interopRequireDefault(require("path"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _Redirect = _interopRequireDefault(require("./components/Redirect"));

var _plugins = _interopRequireDefault(require("./plugins"));

var _utils = require("../utils");

var _chunkBuilder = require("../utils/chunkBuilder");

var _HtmlWithMeta = _interopRequireDefault(require("./components/HtmlWithMeta"));

var _HeadWithMeta = _interopRequireDefault(require("./components/HeadWithMeta"));

var _BodyWithMeta = _interopRequireDefault(require("./components/BodyWithMeta"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

//
var cachedBasePath;
var cachedHrefReplace;
var cachedSrcReplace;

var _default =
/*#__PURE__*/
function () {
  var _exportRoute = (0, _asyncToGenerator2["default"])(
  /*#__PURE__*/
  _regenerator["default"].mark(function _callee(state) {
    var _state, config, DocumentTemplate, route, siteData, clientStats, incremental, _state2, Comp, sharedHashesByProp, template, data, sharedData, routePath, remove, removeLocation, basePath, hrefReplace, srcReplace, routeInfo, embeddedRouteInfo, meta, chunkNames, head, clientScripts, clientStyleSheets, clientCss, FinalComp, renderToStringAndExtract, appHtml, RenderedComp, DocumentHtml, html, publicPath, htmlFilename, routeInfoFilename, res;

    return _regenerator["default"].wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            _state = state, config = _state.config, DocumentTemplate = _state.DocumentTemplate, route = _state.route, siteData = _state.siteData, clientStats = _state.clientStats, incremental = _state.incremental;
            _state2 = state, Comp = _state2.Comp;
            sharedHashesByProp = route.sharedHashesByProp, template = route.template, data = route.data, sharedData = route.sharedData, routePath = route.path, remove = route.remove;

            if (!(incremental && remove)) {
              _context.next = 8;
              break;
            }

            if (!(route.path === '404' || route.path === '/')) {
              _context.next = 6;
              break;
            }

            throw new Error("You are attempting to incrementally remove the ".concat(route.path === '404' ? '404' : 'index', " route from your export. This is currently not supported (or recommended) by React Static."));

          case 6:
            removeLocation = _path["default"].join(config.paths.DIST, route.path);
            return _context.abrupt("return", _fsExtra["default"].remove(removeLocation));

          case 8:
            basePath = cachedBasePath || (cachedBasePath = config.basePath);
            hrefReplace = cachedHrefReplace || (cachedHrefReplace = new RegExp("(href=[\"'])\\/(".concat(basePath ? "".concat(basePath, "\\/") : '', ")?([^\\/])"), 'gm'));
            srcReplace = cachedSrcReplace || (cachedSrcReplace = new RegExp("(src=[\"'])\\/(".concat(basePath ? "".concat(basePath, "\\/") : '', ")?([^\\/])"), 'gm')); // This routeInfo will be saved to disk. It should only include the
            // data and hashes to construct all of the props later.

            routeInfo = {
              template: template,
              sharedHashesByProp: sharedHashesByProp,
              data: data,
              path: routePath // This embeddedRouteInfo will be inlined into the HTML for this route.
              // It should include all of the data, including shared data

            };
            embeddedRouteInfo = _objectSpread({}, routeInfo, {
              sharedData: sharedData,
              siteData: siteData
            });
            state = _objectSpread({}, state, {
              routeInfo: routeInfo,
              embeddedRouteInfo: embeddedRouteInfo // Make a place to collect chunks, meta info and head tags

            });
            meta = {};
            chunkNames = [];
            head = {};
            clientScripts = [];
            clientStyleSheets = [];
            clientCss = {};
            // Get the react component from the Comp and pass it the export context. This
            // uses reactContext under the hood to pass down the exportContext, since
            // react's new context api doesn't survive across bundling.
            Comp = config.disableRuntime ? Comp : Comp(embeddedRouteInfo);

            if (route.redirect) {
              FinalComp = function FinalComp() {
                return _react["default"].createElement(_Redirect["default"], {
                  fromPath: route.path,
                  to: route.redirect
                });
              };
            } else {
              FinalComp = function FinalComp(props) {
                return _react["default"].createElement(_reactUniversalComponent.ReportChunks, {
                  report: function report(chunkName) {
                    // if we are building to a absolute path we must make the detected
                    // chunkName relative and matching to the one we set in
                    // generateTemplates
                    if (!config.paths.DIST.startsWith(config.paths.ROOT)) {
                      chunkName = (0, _chunkBuilder.absoluteToRelativeChunkName)(config.paths.ROOT, chunkName);
                    }

                    chunkNames.push(chunkName);
                  }
                }, _react["default"].createElement(Comp, props));
              };
            }

            renderToStringAndExtract = function renderToStringAndExtract(comp) {
              // Rend the app to string!
              var appHtml = (0, _server.renderToString)(comp);

              var _flushChunks = (0, _webpackFlushChunks["default"])(clientStats, {
                chunkNames: chunkNames,
                outputPath: config.paths.DIST
              }),
                  scripts = _flushChunks.scripts,
                  stylesheets = _flushChunks.stylesheets,
                  css = _flushChunks.css;

              clientScripts = scripts;
              clientStyleSheets = stylesheets;
              clientCss = css; // Extract head calls using Helmet synchronously right after renderToString
              // to not introduce any race conditions in the meta data rendering

              var helmet = _reactHelmet["default"].renderStatic();

              head = {
                htmlProps: helmet.htmlAttributes.toComponent(),
                bodyProps: helmet.bodyAttributes.toComponent(),
                base: helmet.base.toComponent(),
                link: helmet.link.toComponent(),
                meta: helmet.meta.toComponent(),
                noscript: helmet.noscript.toComponent(),
                script: helmet.script.toComponent(),
                style: helmet.style.toComponent(),
                title: helmet.title.toComponent()
              };
              return appHtml;
            };

            state = _objectSpread({}, state, {
              meta: meta
            });
            _context.prev = 24;
            _context.next = 27;
            return _plugins["default"].beforeRenderToElement(FinalComp, state);

          case 27:
            FinalComp = _context.sent;

            if (!config.renderToElement) {
              _context.next = 30;
              break;
            }

            throw new Error("config.renderToElement has been deprecated in favor of the " + "'beforeRenderToElement' or 'beforeRenderToHtml' hooks instead.");

          case 30:
            RenderedComp = _react["default"].createElement(FinalComp, null); // Run the beforeRenderToHtml hook
            // Rum the Html hook

            _context.next = 33;
            return _plugins["default"].beforeRenderToHtml(RenderedComp, state);

          case 33:
            RenderedComp = _context.sent;

            if (!config.renderToHtml) {
              _context.next = 36;
              break;
            }

            throw new Error("config.renderToHtml has been deprecated in favor of the " + "'beforeRenderToHtml' or 'beforeHtmlToDocument' hooks instead.");

          case 36:
            appHtml = renderToStringAndExtract(RenderedComp);
            _context.next = 39;
            return _plugins["default"].beforeHtmlToDocument(appHtml, state);

          case 39:
            appHtml = _context.sent;
            _context.next = 47;
            break;

          case 42:
            _context.prev = 42;
            _context.t0 = _context["catch"](24);

            if (_context.t0.then) {
              _context.t0.message = 'Components are not allowed to suspend during static export. Please ' + 'make its data available synchronously and try again!';
            }

            _context.t0.message = "Failed exporting HTML for URL ".concat(route.path, " (").concat(route.template, "): ").concat(_context.t0.message);
            throw _context.t0;

          case 47:
            state = _objectSpread({}, state, {
              head: head,
              clientScripts: clientScripts,
              clientStyleSheets: clientStyleSheets,
              clientCss: clientCss
            });
            _context.t1 = _server.renderToStaticMarkup;
            _context.t2 = _react["default"];
            _context.t3 = DocumentTemplate;
            _context.next = 53;
            return (0, _HtmlWithMeta["default"])(state);

          case 53:
            _context.t4 = _context.sent;
            _context.next = 56;
            return (0, _HeadWithMeta["default"])(state);

          case 56:
            _context.t5 = _context.sent;
            _context.next = 59;
            return (0, _BodyWithMeta["default"])(state);

          case 59:
            _context.t6 = _context.sent;
            _context.t7 = state;
            _context.t8 = {
              Html: _context.t4,
              Head: _context.t5,
              Body: _context.t6,
              state: _context.t7
            };
            _context.t9 = _react["default"].createElement("div", {
              id: "root",
              dangerouslySetInnerHTML: {
                __html: appHtml
              }
            });
            _context.t10 = _context.t2.createElement.call(_context.t2, _context.t3, _context.t8, _context.t9);
            DocumentHtml = (0, _context.t1)(_context.t10);
            // Render the html for the page inside of the base document.
            html = "<!DOCTYPE html>".concat(DocumentHtml);
            _context.next = 68;
            return _plugins["default"].beforeDocumentToFile(html, state);

          case 68:
            html = _context.sent;
            // If the siteRoot is set and we're not in staging, prefix all absolute URLs
            // with the siteRoot
            publicPath = (0, _utils.makePathAbsolute)(process.env.REACT_STATIC_PUBLIC_PATH);

            if (process.env.REACT_STATIC_DISABLE_ROUTE_PREFIXING !== 'true') {
              html = html.replace(hrefReplace, "$1".concat(publicPath, "$3"));
            }

            html = html.replace(srcReplace, "$1".concat(publicPath, "$3")); // If the route is a 404 page, write it directly to 404.html, instead of
            // inside a directory.

            htmlFilename = route.path === '404' ? _path["default"].join(config.paths.DIST, '404.html') : _path["default"].join(config.paths.DIST, route.path, 'index.html'); // Make the routeInfo sit right next to its companion html file

            routeInfoFilename = _path["default"].join(config.paths.DIST, route.path, 'routeInfo.json');
            _context.next = 76;
            return Promise.all([_fsExtra["default"].outputFile(htmlFilename, html), !route.redirect ? _fsExtra["default"].outputJson(routeInfoFilename, routeInfo) : Promise.resolve()]);

          case 76:
            res = _context.sent;
            return _context.abrupt("return", res);

          case 78:
          case "end":
            return _context.stop();
        }
      }
    }, _callee, null, [[24, 42]]);
  }));

  function exportRoute(_x) {
    return _exportRoute.apply(this, arguments);
  }

  return exportRoute;
}();

exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdGF0aWMvZXhwb3J0Um91dGUuanMiXSwibmFtZXMiOlsiY2FjaGVkQmFzZVBhdGgiLCJjYWNoZWRIcmVmUmVwbGFjZSIsImNhY2hlZFNyY1JlcGxhY2UiLCJzdGF0ZSIsImNvbmZpZyIsIkRvY3VtZW50VGVtcGxhdGUiLCJyb3V0ZSIsInNpdGVEYXRhIiwiY2xpZW50U3RhdHMiLCJpbmNyZW1lbnRhbCIsIkNvbXAiLCJzaGFyZWRIYXNoZXNCeVByb3AiLCJ0ZW1wbGF0ZSIsImRhdGEiLCJzaGFyZWREYXRhIiwicm91dGVQYXRoIiwicGF0aCIsInJlbW92ZSIsIkVycm9yIiwicmVtb3ZlTG9jYXRpb24iLCJub2RlUGF0aCIsImpvaW4iLCJwYXRocyIsIkRJU1QiLCJmcyIsImJhc2VQYXRoIiwiaHJlZlJlcGxhY2UiLCJSZWdFeHAiLCJzcmNSZXBsYWNlIiwicm91dGVJbmZvIiwiZW1iZWRkZWRSb3V0ZUluZm8iLCJtZXRhIiwiY2h1bmtOYW1lcyIsImhlYWQiLCJjbGllbnRTY3JpcHRzIiwiY2xpZW50U3R5bGVTaGVldHMiLCJjbGllbnRDc3MiLCJkaXNhYmxlUnVudGltZSIsInJlZGlyZWN0IiwiRmluYWxDb21wIiwicHJvcHMiLCJjaHVua05hbWUiLCJzdGFydHNXaXRoIiwiUk9PVCIsInB1c2giLCJyZW5kZXJUb1N0cmluZ0FuZEV4dHJhY3QiLCJjb21wIiwiYXBwSHRtbCIsIm91dHB1dFBhdGgiLCJzY3JpcHRzIiwic3R5bGVzaGVldHMiLCJjc3MiLCJoZWxtZXQiLCJIZWxtZXQiLCJyZW5kZXJTdGF0aWMiLCJodG1sUHJvcHMiLCJodG1sQXR0cmlidXRlcyIsInRvQ29tcG9uZW50IiwiYm9keVByb3BzIiwiYm9keUF0dHJpYnV0ZXMiLCJiYXNlIiwibGluayIsIm5vc2NyaXB0Iiwic2NyaXB0Iiwic3R5bGUiLCJ0aXRsZSIsInBsdWdpbnMiLCJiZWZvcmVSZW5kZXJUb0VsZW1lbnQiLCJyZW5kZXJUb0VsZW1lbnQiLCJSZW5kZXJlZENvbXAiLCJiZWZvcmVSZW5kZXJUb0h0bWwiLCJyZW5kZXJUb0h0bWwiLCJiZWZvcmVIdG1sVG9Eb2N1bWVudCIsInRoZW4iLCJtZXNzYWdlIiwicmVuZGVyVG9TdGF0aWNNYXJrdXAiLCJfX2h0bWwiLCJEb2N1bWVudEh0bWwiLCJodG1sIiwiYmVmb3JlRG9jdW1lbnRUb0ZpbGUiLCJwdWJsaWNQYXRoIiwicHJvY2VzcyIsImVudiIsIlJFQUNUX1NUQVRJQ19QVUJMSUNfUEFUSCIsIlJFQUNUX1NUQVRJQ19ESVNBQkxFX1JPVVRFX1BSRUZJWElORyIsInJlcGxhY2UiLCJodG1sRmlsZW5hbWUiLCJyb3V0ZUluZm9GaWxlbmFtZSIsIlByb21pc2UiLCJhbGwiLCJvdXRwdXRGaWxlIiwib3V0cHV0SnNvbiIsInJlc29sdmUiLCJyZXMiLCJleHBvcnRSb3V0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBO0FBRUEsSUFBSUEsY0FBSjtBQUNBLElBQUlDLGlCQUFKO0FBQ0EsSUFBSUMsZ0JBQUo7Ozs7Ozs7K0JBRWdCLGlCQUEyQkMsS0FBM0I7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLHFCQVFWQSxLQVJVLEVBRVpDLE1BRlksVUFFWkEsTUFGWSxFQUdaQyxnQkFIWSxVQUdaQSxnQkFIWSxFQUlaQyxLQUpZLFVBSVpBLEtBSlksRUFLWkMsUUFMWSxVQUtaQSxRQUxZLEVBTVpDLFdBTlksVUFNWkEsV0FOWSxFQU9aQyxXQVBZLFVBT1pBLFdBUFk7QUFBQSxzQkFVQ04sS0FWRCxFQVVSTyxJQVZRLFdBVVJBLElBVlE7QUFhWkMsWUFBQUEsa0JBYlksR0FtQlZMLEtBbkJVLENBYVpLLGtCQWJZLEVBY1pDLFFBZFksR0FtQlZOLEtBbkJVLENBY1pNLFFBZFksRUFlWkMsSUFmWSxHQW1CVlAsS0FuQlUsQ0FlWk8sSUFmWSxF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SixZQUFkLEVBQTRCUixJQUE1QixDQUQ0QixFQUU1QixDQUFDeEUsS0FBSyxDQUFDZ0MsUUFBUCxHQUNJZCxvQkFBR21FLFVBQUgsQ0FBY0osaUJBQWQsRUFBaUMxRCxTQUFqQyxDQURKLEdBRUkyRCxPQUFPLENBQUNJLE9BQVIsRUFKd0IsQ0FBWixDQXRPSjs7QUFBQTtBQXNPUkMsWUFBQUEsR0F0T1E7QUFBQSw2Q0E0T1BBLEdBNU9POztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEc7O1dBQWVDLFc7Ozs7U0FBQUEsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCdcbmltcG9ydCB7IHJlbmRlclRvU3RyaW5nLCByZW5kZXJUb1N0YXRpY01hcmt1cCB9IGZyb20gJ3JlYWN0LWRvbS9zZXJ2ZXInXG5pbXBvcnQgSGVsbWV0IGZyb20gJ3JlYWN0LWhlbG1ldCdcbmltcG9ydCB7IFJlcG9ydENodW5rcyB9IGZyb20gJ3JlYWN0LXVuaXZlcnNhbC1jb21wb25lbnQnXG5pbXBvcnQgZmx1c2hDaHVua3MgZnJvbSAnd2VicGFjay1mbHVzaC1jaHVua3MnXG5pbXBvcnQgbm9kZVBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSdcblxuaW1wb3J0IFJlZGlyZWN0IGZyb20gJy4vY29tcG9uZW50cy9SZWRpcmVjdCdcbmltcG9ydCBwbHVnaW5zIGZyb20gJy4vcGx1Z2lucydcbmltcG9ydCB7IG1ha2VQYXRoQWJzb2x1dGUgfSBmcm9tICcuLi91dGlscydcbmltcG9ydCB7IGFic29sdXRlVG9SZWxhdGl2ZUNodW5rTmFtZSB9IGZyb20gJy4uL3V0aWxzL2NodW5rQnVpbGRlcidcblxuaW1wb3J0IG1ha2VIdG1sV2l0aE1ldGEgZnJvbSAnLi9jb21wb25lbnRzL0h0bWxXaXRoTWV0YSdcbmltcG9ydCBtYWtlSGVhZFdpdGhNZXRhIGZyb20gJy4vY29tcG9uZW50cy9IZWFkV2l0aE1ldGEnXG5pbXBvcnQgbWFrZUJvZHlXaXRoTWV0YSBmcm9tICcuL2NvbXBvbmVudHMvQm9keVdpdGhNZXRhJ1xuXG4vL1xuXG5sZXQgY2FjaGVkQmFzZVBhdGhcbmxldCBjYWNoZWRIcmVmUmVwbGFjZVxubGV0IGNhY2hlZFNyY1JlcGxhY2VcblxuZXhwb3J0IGRlZmF1bHQgKGFzeW5jIGZ1bmN0aW9uIGV4cG9ydFJvdXRlKHN0YXRlKSB7XG4gIGNvbnN0IHtcbiAgICBjb25maWcsXG4gICAgRG9jdW1lbnRUZW1wbGF0ZSxcbiAgICByb3V0ZSxcbiAgICBzaXRlRGF0YSxcbiAgICBjbGllbnRTdGF0cyxcbiAgICBpbmNyZW1lbnRhbCxcbiAgfSA9IHN0YXRlXG5cbiAgbGV0IHsgQ29tcCB9ID0gc3RhdGVcblxuICBjb25zdCB7XG4gICAgc2hhcmVkSGFzaGVzQnlQcm9wLFxuICAgIHRlbXBsYXRlLFxuICAgIGRhdGEsXG4gICAgc2hhcmVkRGF0YSxcbiAgICBwYXRoOiByb3V0ZVBhdGgsXG4gICAgcmVtb3ZlLFxuICB9ID0gcm91dGVcblxuICBpZiAoaW5jcmVtZW50YWwgJiYgcmVtb3ZlKSB7XG4gICAgaWYgKHJvdXRlLnBhdGggPT09ICc0MDQnIHx8IHJvdXRlLnBhdGggPT09ICcvJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgWW91IGFyZSBhdHRlbXB0aW5nIHRvIGluY3JlbWVudGFsbHkgcmVtb3ZlIHRoZSAke1xuICAgICAgICAgIHJvdXRlLnBhdGggPT09ICc0MDQnID8gJzQwNCcgOiAnaW5kZXgnXG4gICAgICAgIH0gcm91dGUgZnJvbSB5b3VyIGV4cG9ydC4gVGhpcyBpcyBjdXJyZW50bHkgbm90IHN1cHBvcnRlZCAob3IgcmVjb21tZW5kZWQpIGJ5IFJlYWN0IFN0YXRpYy5gXG4gICAgICApXG4gICAgfVxuICAgIGNvbnN0IHJlbW92ZUxvY2F0aW9uID0gbm9kZVBhdGguam9pbihjb25maWcucGF0aHMuRElTVCwgcm91dGUucGF0aClcbiAgICByZXR1cm4gZnMucmVtb3ZlKHJlbW92ZUxvY2F0aW9uKVxuICB9XG5cbiAgY29uc3QgYmFzZVBhdGggPSBjYWNoZWRCYXNlUGF0aCB8fCAoY2FjaGVkQmFzZVBhdGggPSBjb25maWcuYmFzZVBhdGgpXG5cbiAgY29uc3QgaHJlZlJlcGxhY2UgPVxuICAgIGNhY2hlZEhyZWZSZXBsYWNlIHx8XG4gICAgKGNhY2hlZEhyZWZSZXBsYWNlID0gbmV3IFJlZ0V4cChcbiAgICAgIGAoaHJlZj1bXCInXSlcXFxcLygke2Jhc2VQYXRoID8gYCR7YmFzZVBhdGh9XFxcXC9gIDogJyd9KT8oW15cXFxcL10pYCxcbiAgICAgICdnbSdcbiAgICApKVxuXG4gIGNvbnN0IHNyY1JlcGxhY2UgPVxuICAgIGNhY2hlZFNyY1JlcGxhY2UgfHxcbiAgICAoY2FjaGVkU3JjUmVwbGFjZSA9IG5ldyBSZWdFeHAoXG4gICAgICBgKHNyYz1bXCInXSlcXFxcLygke2Jhc2VQYXRoID8gYCR7YmFzZVBhdGh9XFxcXC9gIDogJyd9KT8oW15cXFxcL10pYCxcbiAgICAgICdnbSdcbiAgICApKVxuXG4gIC8vIFRoaXMgcm91dGVJbmZvIHdpbGwgYmUgc2F2ZWQgdG8gZGlzay4gSXQgc2hvdWxkIG9ubHkgaW5jbHVkZSB0aGVcbiAgLy8gZGF0YSBhbmQgaGFzaGVzIHRvIGNvbnN0cnVjdCBhbGwgb2YgdGhlIHByb3BzIGxhdGVyLlxuICBjb25zdCByb3V0ZUluZm8gPSB7XG4gICAgdGVtcGxhdGUsXG4gICAgc2hhcmVkSGFzaGVzQnlQcm9wLFxuICAgIGRhdGEsXG4gICAgcGF0aDogcm91dGVQYXRoLFxuICB9XG5cbiAgLy8gVGhpcyBlbWJlZGRlZFJvdXRlSW5mbyB3aWxsIGJlIGlubGluZWQgaW50byB0aGUgSFRNTCBmb3IgdGhpcyByb3V0ZS5cbiAgLy8gSXQgc2hvdWxkIGluY2x1ZGUgYWxsIG9mIHRoZSBkYXRhLCBpbmNsdWRpbmcgc2hhcmVkIGRhdGFcbiAgY29uc3QgZW1iZWRkZWRSb3V0ZUluZm8gPSB7XG4gICAgLi4ucm91dGVJbmZvLFxuICAgIHNoYXJlZERhdGEsXG4gICAgc2l0ZURhdGEsXG4gIH1cblxuICBzdGF0ZSA9IHtcbiAgICAuLi5zdGF0ZSxcbiAgICByb3V0ZUluZm8sXG4gICAgZW1iZWRkZWRSb3V0ZUluZm8sXG4gIH1cblxuICAvLyBNYWtlIGEgcGxhY2UgdG8gY29sbGVjdCBjaHVua3MsIG1ldGEgaW5mbyBhbmQgaGVhZCB0YWdzXG4gIGNvbnN0IG1ldGEgPSB7fVxuICBjb25zdCBjaHVua05hbWVzID0gW11cbiAgbGV0IGhlYWQgPSB7fVxuICBsZXQgY2xpZW50U2NyaXB0cyA9IFtdXG4gIGxldCBjbGllbnRTdHlsZVNoZWV0cyA9IFtdXG4gIGxldCBjbGllbnRDc3MgPSB7fVxuXG4gIGxldCBGaW5hbENvbXBcblxuICAvLyBHZXQgdGhlIHJlYWN0IGNvbXBvbmVudCBmcm9tIHRoZSBDb21wIGFuZCBwYXNzIGl0IHRoZSBleHBvcnQgY29udGV4dC4gVGhpc1xuICAvLyB1c2VzIHJlYWN0Q29udGV4dCB1bmRlciB0aGUgaG9vZCB0byBwYXNzIGRvd24gdGhlIGV4cG9ydENvbnRleHQsIHNpbmNlXG4gIC8vIHJlYWN0J3MgbmV3IGNvbnRleHQgYXBpIGRvZXNuJ3Qgc3Vydml2ZSBhY3Jvc3MgYnVuZGxpbmcuXG4gIENvbXAgPSBjb25maWcuZGlzYWJsZVJ1bnRpbWUgPyBDb21wIDogQ29tcChlbWJlZGRlZFJvdXRlSW5mbylcblxuICBpZiAocm91dGUucmVkaXJlY3QpIHtcbiAgICBGaW5hbENvbXAgPSAoKSA9PiA8UmVkaXJlY3QgZnJvbVBhdGg9e3JvdXRlLnBhdGh9IHRvPXtyb3V0ZS5yZWRpcmVjdH0gLz5cbiAgfSBlbHNlIHtcbiAgICBGaW5hbENvbXAgPSBwcm9wcyA9PiAoXG4gICAgICA8UmVwb3J0Q2h1bmtzXG4gICAgICAgIHJlcG9ydD17Y2h1bmtOYW1lID0+IHtcbiAgICAgICAgICAvLyBpZiB3ZSBhcmUgYnVpbGRpbmcgdG8gYSBhYnNvbHV0ZSBwYXRoIHdlIG11c3QgbWFrZSB0aGUgZGV0ZWN0ZWRcbiAgICAgICAgICAvLyBjaHVua05hbWUgcmVsYXRpdmUgYW5kIG1hdGNoaW5nIHRvIHRoZSBvbmUgd2Ugc2V0IGluXG4gICAgICAgICAgLy8gZ2VuZXJhdGVUZW1wbGF0ZXNcbiAgICAgICAgICBpZiAoIWNvbmZpZy5wYXRocy5ESVNULnN0YXJ0c1dpdGgoY29uZmlnLnBhdGhzLlJPT1QpKSB7XG4gICAgICAgICAgICBjaHVua05hbWUgPSBhYnNvbHV0ZVRvUmVsYXRpdmVDaHVua05hbWUoXG4gICAgICAgICAgICAgIGNvbmZpZy5wYXRocy5ST09ULFxuICAgICAgICAgICAgICBjaHVua05hbWVcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjaHVua05hbWVzLnB1c2goY2h1bmtOYW1lKVxuICAgICAgICB9fVxuICAgICAgPlxuICAgICAgICA8Q29tcCB7Li4ucHJvcHN9IC8+XG4gICAgICA8L1JlcG9ydENodW5rcz5cbiAgICApXG4gIH1cblxuICBjb25zdCByZW5kZXJUb1N0cmluZ0FuZEV4dHJhY3QgPSBjb21wID0+IHtcbiAgICAvLyBSZW5kIHRoZSBhcHAgdG8gc3RyaW5nIVxuICAgIGNvbnN0IGFwcEh0bWwgPSByZW5kZXJUb1N0cmluZyhjb21wKVxuICAgIGNvbnN0IHsgc2NyaXB0cywgc3R5bGVzaGVldHMsIGNzcyB9ID0gZmx1c2hDaHVua3MoY2xpZW50U3RhdHMsIHtcbiAgICAgIGNodW5rTmFtZXMsXG4gICAgICBvdXRwdXRQYXRoOiBjb25maWcucGF0aHMuRElTVCxcbiAgICB9KVxuXG4gICAgY2xpZW50U2NyaXB0cyA9IHNjcmlwdHNcbiAgICBjbGllbnRTdHlsZVNoZWV0cyA9IHN0eWxlc2hlZXRzXG4gICAgY2xpZW50Q3NzID0gY3NzXG4gICAgLy8gRXh0cmFjdCBoZWFkIGNhbGxzIHVzaW5nIEhlbG1ldCBzeW5jaHJvbm91c2x5IHJpZ2h0IGFmdGVyIHJlbmRlclRvU3RyaW5nXG4gICAgLy8gdG8gbm90IGludHJvZHVjZSBhbnkgcmFjZSBjb25kaXRpb25zIGluIHRoZSBtZXRhIGRhdGEgcmVuZGVyaW5nXG4gICAgY29uc3QgaGVsbWV0ID0gSGVsbWV0LnJlbmRlclN0YXRpYygpXG4gICAgaGVhZCA9IHtcbiAgICAgIGh0bWxQcm9wczogaGVsbWV0Lmh0bWxBdHRyaWJ1dGVzLnRvQ29tcG9uZW50KCksXG4gICAgICBib2R5UHJvcHM6IGhlbG1ldC5ib2R5QXR0cmlidXRlcy50b0NvbXBvbmVudCgpLFxuICAgICAgYmFzZTogaGVsbWV0LmJhc2UudG9Db21wb25lbnQoKSxcbiAgICAgIGxpbms6IGhlbG1ldC5saW5rLnRvQ29tcG9uZW50KCksXG4gICAgICBtZXRhOiBoZWxtZXQubWV0YS50b0NvbXBvbmVudCgpLFxuICAgICAgbm9zY3JpcHQ6IGhlbG1ldC5ub3NjcmlwdC50b0NvbXBvbmVudCgpLFxuICAgICAgc2NyaXB0OiBoZWxtZXQuc2NyaXB0LnRvQ29tcG9uZW50KCksXG4gICAgICBzdHlsZTogaGVsbWV0LnN0eWxlLnRvQ29tcG9uZW50KCksXG4gICAgICB0aXRsZTogaGVsbWV0LnRpdGxlLnRvQ29tcG9uZW50KCksXG4gICAgfVxuXG4gICAgcmV0dXJuIGFwcEh0bWxcbiAgfVxuXG4gIGxldCBhcHBIdG1sXG5cbiAgc3RhdGUgPSB7XG4gICAgLi4uc3RhdGUsXG4gICAgbWV0YSxcbiAgfVxuXG4gIHRyeSB7XG4gICAgRmluYWxDb21wID0gYXdhaXQgcGx1Z2lucy5iZWZvcmVSZW5kZXJUb0VsZW1lbnQoRmluYWxDb21wLCBzdGF0ZSlcblxuICAgIGlmIChjb25maWcucmVuZGVyVG9FbGVtZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBjb25maWcucmVuZGVyVG9FbGVtZW50IGhhcyBiZWVuIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgdGhlIGAgK1xuICAgICAgICAgIGAnYmVmb3JlUmVuZGVyVG9FbGVtZW50JyBvciAnYmVmb3JlUmVuZGVyVG9IdG1sJyBob29rcyBpbnN0ZWFkLmBcbiAgICAgIClcbiAgICB9XG5cbiAgICBsZXQgUmVuZGVyZWRDb21wID0gPEZpbmFsQ29tcCAvPlxuXG4gICAgLy8gUnVuIHRoZSBiZWZvcmVSZW5kZXJUb0h0bWwgaG9va1xuICAgIC8vIFJ1bSB0aGUgSHRtbCBob29rXG4gICAgUmVuZGVyZWRDb21wID0gYXdhaXQgcGx1Z2lucy5iZWZvcmVSZW5kZXJUb0h0bWwoUmVuZGVyZWRDb21wLCBzdGF0ZSlcblxuICAgIGlmIChjb25maWcucmVuZGVyVG9IdG1sKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBjb25maWcucmVuZGVyVG9IdG1sIGhhcyBiZWVuIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgdGhlIGAgK1xuICAgICAgICAgIGAnYmVmb3JlUmVuZGVyVG9IdG1sJyBvciAnYmVmb3JlSHRtbFRvRG9jdW1lbnQnIGhvb2tzIGluc3RlYWQuYFxuICAgICAgKVxuICAgIH1cblxuICAgIGFwcEh0bWwgPSByZW5kZXJUb1N0cmluZ0FuZEV4dHJhY3QoUmVuZGVyZWRDb21wKVxuXG4gICAgYXBwSHRtbCA9IGF3YWl0IHBsdWdpbnMuYmVmb3JlSHRtbFRvRG9jdW1lbnQoYXBwSHRtbCwgc3RhdGUpXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yLnRoZW4pIHtcbiAgICAgIGVycm9yLm1lc3NhZ2UgPVxuICAgICAgICAnQ29tcG9uZW50cyBhcmUgbm90IGFsbG93ZWQgdG8gc3VzcGVuZCBkdXJpbmcgc3RhdGljIGV4cG9ydC4gUGxlYXNlICcgK1xuICAgICAgICAnbWFrZSBpdHMgZGF0YSBhdmFpbGFibGUgc3luY2hyb25vdXNseSBhbmQgdHJ5IGFnYWluISdcbiAgICB9XG4gICAgZXJyb3IubWVzc2FnZSA9IGBGYWlsZWQgZXhwb3J0aW5nIEhUTUwgZm9yIFVSTCAke3JvdXRlLnBhdGh9ICgke3JvdXRlLnRlbXBsYXRlfSk6ICR7ZXJyb3IubWVzc2FnZX1gXG4gICAgdGhyb3cgZXJyb3JcbiAgfVxuXG4gIHN0YXRlID0ge1xuICAgIC4uLnN0YXRlLFxuICAgIGhlYWQsXG4gICAgY2xpZW50U2NyaXB0cyxcbiAgICBjbGllbnRTdHlsZVNoZWV0cyxcbiAgICBjbGllbnRDc3MsXG4gIH1cblxuICBjb25zdCBEb2N1bWVudEh0bWwgPSByZW5kZXJUb1N0YXRpY01hcmt1cChcbiAgICA8RG9jdW1lbnRUZW1wbGF0ZVxuICAgICAgSHRtbD17YXdhaXQgbWFrZUh0bWxXaXRoTWV0YShzdGF0ZSl9XG4gICAgICBIZWFkPXthd2FpdCBtYWtlSGVhZFdpdGhNZXRhKHN0YXRlKX1cbiAgICAgIEJvZHk9e2F3YWl0IG1ha2VCb2R5V2l0aE1ldGEoc3RhdGUpfVxuICAgICAgc3RhdGU9e3N0YXRlfVxuICAgID5cbiAgICAgIDxkaXYgaWQ9XCJyb290XCIgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUw9e3sgX19odG1sOiBhcHBIdG1sIH19IC8+XG4gICAgPC9Eb2N1bWVudFRlbXBsYXRlPlxuICApXG5cbiAgLy8gUmVuZGVyIHRoZSBodG1sIGZvciB0aGUgcGFnZSBpbnNpZGUgb2YgdGhlIGJhc2UgZG9jdW1lbnQuXG4gIGxldCBodG1sID0gYDwhRE9DVFlQRSBodG1sPiR7RG9jdW1lbnRIdG1sfWBcblxuICBodG1sID0gYXdhaXQgcGx1Z2lucy5iZWZvcmVEb2N1bWVudFRvRmlsZShodG1sLCBzdGF0ZSlcblxuICAvLyBJZiB0aGUgc2l0ZVJvb3QgaXMgc2V0IGFuZCB3ZSdyZSBub3QgaW4gc3RhZ2luZywgcHJlZml4IGFsbCBhYnNvbHV0ZSBVUkxzXG4gIC8vIHdpdGggdGhlIHNpdGVSb290XG4gIGNvbnN0IHB1YmxpY1BhdGggPSBtYWtlUGF0aEFic29sdXRlKHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19QVUJMSUNfUEFUSClcbiAgaWYgKHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19ESVNBQkxFX1JPVVRFX1BSRUZJWElORyAhPT0gJ3RydWUnKSB7XG4gICAgaHRtbCA9IGh0bWwucmVwbGFjZShocmVmUmVwbGFjZSwgYCQxJHtwdWJsaWNQYXRofSQzYClcbiAgfVxuXG4gIGh0bWwgPSBodG1sLnJlcGxhY2Uoc3JjUmVwbGFjZSwgYCQxJHtwdWJsaWNQYXRofSQzYClcblxuICAvLyBJZiB0aGUgcm91dGUgaXMgYSA0MDQgcGFnZSwgd3JpdGUgaXQgZGlyZWN0bHkgdG8gNDA0Lmh0bWwsIGluc3RlYWQgb2ZcbiAgLy8gaW5zaWRlIGEgZGlyZWN0b3J5LlxuICBjb25zdCBodG1sRmlsZW5hbWUgPVxuICAgIHJvdXRlLnBhdGggPT09ICc0MDQnXG4gICAgICA/IG5vZGVQYXRoLmpvaW4oY29uZmlnLnBhdGhzLkRJU1QsICc0MDQuaHRtbCcpXG4gICAgICA6IG5vZGVQYXRoLmpvaW4oY29uZmlnLnBhdGhzLkRJU1QsIHJvdXRlLnBhdGgsICdpbmRleC5odG1sJylcblxuICAvLyBNYWtlIHRoZSByb3V0ZUluZm8gc2l0IHJpZ2h0IG5leHQgdG8gaXRzIGNvbXBhbmlvbiBodG1sIGZpbGVcbiAgY29uc3Qgcm91dGVJbmZvRmlsZW5hbWUgPSBub2RlUGF0aC5qb2luKFxuICAgIGNvbmZpZy5wYXRocy5ESVNULFxuICAgIHJvdXRlLnBhdGgsXG4gICAgJ3JvdXRlSW5mby5qc29uJ1xuICApXG5cbiAgY29uc3QgcmVzID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgIGZzLm91dHB1dEZpbGUoaHRtbEZpbGVuYW1lLCBodG1sKSxcbiAgICAhcm91dGUucmVkaXJlY3RcbiAgICAgID8gZnMub3V0cHV0SnNvbihyb3V0ZUluZm9GaWxlbmFtZSwgcm91dGVJbmZvKVxuICAgICAgOiBQcm9taXNlLnJlc29sdmUoKSxcbiAgXSlcbiAgcmV0dXJuIHJlc1xufSlcbiJdfQ==